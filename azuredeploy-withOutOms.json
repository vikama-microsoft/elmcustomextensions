{
   "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "name":{
         "type":"String",
         "metadata":{
            "Description":"Name of the Logicapp"
         }
      },
      "location":{
         "type":"String",
         "defaultValue":"[resourceGroup().location]",
         "metadata":{
            "Description":"Deployment location"
         }
      },
      "catalogId":{
         "type":"String",
         "metadata":{
            "Description":"Catalog Id from Entitlement Management"
         }
      },
      "nonce":{
         "type":"String",
         "defaultValue":"[newGuid()]",
         "metadata":{
            "Description":"Nonce for logic app authorization policies"
         }
      },
      "armResource":{
         "type":"String",
         "defaultValue":"management.azure.com",
         "metadata":{
            "Description":"ARM resource based on the cloud"
         }
      }
   },
   "variables":{
      "catalogIdExpression":"@{triggerBody()?['CatalogId']}",
      "possession":"[concat(resourceGroup().id, '/providers/Microsoft.Logic/workflows/', parameters('name'))]"
   },
   "resources":[
      {
         "type":"Microsoft.Logic/workflows",
         "apiVersion":"2019-05-01",
         "name":"[parameters('name')]",
         "location":"[parameters('location')]",
         "tags":{
            "Purpose":"Azure AD Entitlement Management"
         },
         "properties":{
            "state":"Enabled",
            "definition":{
               "$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
               "contentVersion":"1.0.0.0",
               "parameters":{
                  
               },
               "triggers":{
                  "manual":{
                     "type":"Request",
                     "kind":"Http",
                     "inputs":{
                        "schema":{
                           "properties":{
                              "AccessPackage":{
                                 "properties":{
                                    "AccessPackageAssignmentPolicies":{
                                       
                                    },
                                    "AccessPackageResourceRoleScopes":{
                                       "items":{
                                          "properties":{
                                             "accessPackageResourceRole":{
                                                "properties":{
                                                   "displayName":{
                                                      "type":"string"
                                                   },
                                                   "id":{
                                                      "type":"string"
                                                   },
                                                   "originId":{
                                                      "type":"string"
                                                   },
                                                   "originSystem":{
                                                      "type":"string"
                                                   }
                                                },
                                                "type":"object"
                                             },
                                             "accessPackageResourceScope":{
                                                "properties":{
                                                   "description":{
                                                      "type":"string"
                                                   },
                                                   "displayName":{
                                                      "type":"string"
                                                   },
                                                   "id":{
                                                      "type":"string"
                                                   },
                                                   "isRootScope":{
                                                      "type":"boolean"
                                                   },
                                                   "originId":{
                                                      "type":"string"
                                                   },
                                                   "originSystem":{
                                                      "type":"string"
                                                   }
                                                },
                                                "type":"object"
                                             },
                                             "createdBy":{
                                                "type":"string"
                                             },
                                             "createdDateTime":{
                                                "type":"string"
                                             },
                                             "id":{
                                                "type":"string"
                                             },
                                             "modifiedBy":{
                                                "type":"string"
                                             },
                                             "modifiedDateTime":{
                                                "type":"string"
                                             }
                                          },
                                          "required":[
                                             "id",
                                             "createdBy",
                                             "createdDateTime",
                                             "modifiedBy",
                                             "modifiedDateTime",
                                             "accessPackageResourceRole",
                                             "accessPackageResourceScope"
                                          ],
                                          "type":"object"
                                       },
                                       "type":"array"
                                    },
                                    "AccessPackagesIncompatibleWith":{
                                       
                                    },
                                    "AdditionalInfo":{
                                       
                                    },
                                    "AssignmentPolicies":{
                                       
                                    },
                                    "CatalogId":{
                                       "type":"string"
                                    },
                                    "CreatedBy":{
                                       "type":"string"
                                    },
                                    "CreatedByString":{
                                       "type":"string"
                                    },
                                    "CreatedDateTime":{
                                       "type":"string"
                                    },
                                    "Description":{
                                       "type":"string"
                                    },
                                    "DisplayName":{
                                       "type":"string"
                                    },
                                    "Id":{
                                       "type":"string"
                                    },
                                    "IncompatibleAccessPackages":{
                                       
                                    },
                                    "IncompatibleGroups":{
                                       
                                    },
                                    "IsHidden":{
                                       "type":"boolean"
                                    },
                                    "IsRoleScopesVisible":{
                                       "type":"boolean"
                                    },
                                    "LastCriticalModificationDateTime":{
                                       
                                    },
                                    "LastModifiedByString":{
                                       "type":"string"
                                    },
                                    "LastModifiedDateTime":{
                                       "type":"string"
                                    },
                                    "LastSuccessfulChangeEvaluationDateTime":{
                                       
                                    },
                                    "ModifiedBy":{
                                       "type":"string"
                                    },
                                    "ModifiedDateTime":{
                                       "type":"string"
                                    }
                                 },
                                 "type":"object"
                              },
                              "AccessPackageAssignmentRequestId":{
                                 "type":"string"
                              },
                              "AccessPackageCatalog":{
                                 "properties":{
                                    "AccessPackageCustomWorkflowExtensions":{
                                       
                                    },
                                    "AccessPackageResourceRoles":{
                                       
                                    },
                                    "AccessPackageResourceScopes":{
                                       
                                    },
                                    "AccessPackageResources":{
                                       
                                    },
                                    "AccessPackages":{
                                       
                                    },
                                    "AdditionalInfo":{
                                       
                                    },
                                    "CatalogStatus":{
                                       "type":"string"
                                    },
                                    "CatalogType":{
                                       "type":"string"
                                    },
                                    "CreatedBy":{
                                       "type":"string"
                                    },
                                    "CreatedByString":{
                                       "type":"string"
                                    },
                                    "CreatedDateTime":{
                                       "type":"string"
                                    },
                                    "CustomAccessPackageWorkflowExtensions":{
                                       
                                    },
                                    "CustomExtensions":{
                                       
                                    },
                                    "Description":{
                                       "type":"string"
                                    },
                                    "DisplayName":{
                                       "type":"string"
                                    },
                                    "Id":{
                                       "type":"string"
                                    },
                                    "IsExternallyVisible":{
                                       "type":"boolean"
                                    },
                                    "LastModifiedByString":{
                                       "type":"string"
                                    },
                                    "LastModifiedDateTime":{
                                       "type":"string"
                                    },
                                    "ModifiedBy":{
                                       "type":"string"
                                    },
                                    "ModifiedDateTime":{
                                       "type":"string"
                                    },
                                    "ResourceRoles":{
                                       
                                    },
                                    "ResourceScopes":{
                                       
                                    },
                                    "Resources":{
                                       
                                    },
                                    "State":{
                                       "type":"string"
                                    }
                                 },
                                 "type":"object"
                              },
                              "Answers":{
                                 "type":"array"
                              },
                              "Assignment":{
                                 "properties":{
                                    "AccessPackageAssignmentPolicy":{
                                       "properties":{
                                          "Description":{
                                             "type":"string"
                                          },
                                          "DisplayName":{
                                             "type":"string"
                                          },
                                          "Id":{
                                             "type":"string"
                                          }
                                       },
                                       "type":"object"
                                    },
                                    "AccessPackageAssignmentRequests":{
                                       
                                    },
                                    "AccessPackageAssignmentResourceRoles":{
                                       "items":{
                                          "properties":{
                                             "id":{
                                                "type":"string"
                                             },
                                             "originId":{
                                                "type":"string"
                                             },
                                             "originSystem":{
                                                "type":"string"
                                             },
                                             "status":{
                                                "type":"string"
                                             }
                                          },
                                          "required":[
                                             "id",
                                             "originId",
                                             "originSystem",
                                             "status"
                                          ],
                                          "type":"object"
                                       },
                                       "type":"array"
                                    },
                                    "AccessPackageId":{
                                       "type":"string"
                                    },
                                    "AccessReviewSettings":{
                                       
                                    },
                                    "AssignmentPolicyId":{
                                       "type":"string"
                                    },
                                    "AssignmentReviewSettings":{
                                       
                                    },
                                    "AssignmentState":{
                                       "type":"string"
                                    },
                                    "AssignmentStatus":{
                                       "type":"string"
                                    },
                                    "AutoAssignmentSettings":{
                                       
                                    },
                                    "CatalogId":{
                                       "type":"string"
                                    },
                                    "CreatedDateTime":{
                                       
                                    },
                                    "ExpiredDateTime":{
                                       
                                    },
                                    "Id":{
                                       "type":"string"
                                    },
                                    "IsExtended":{
                                       "type":"boolean"
                                    },
                                    "ModifiedDateTime":{
                                       
                                    },
                                    "RequestApprovalSettings":{
                                       "properties":{
                                          "ApprovalMode":{
                                             "type":"string"
                                          },
                                          "ApprovalStages":{
                                             "type":"array"
                                          },
                                          "IsApprovalRequired":{
                                             "type":"boolean"
                                          },
                                          "IsApprovalRequiredForExtension":{
                                             "type":"boolean"
                                          },
                                          "IsApprovalRequiredForUpdate":{
                                             "type":"boolean"
                                          },
                                          "IsRequestorJustificationRequired":{
                                             "type":"boolean"
                                          }
                                       },
                                       "type":"object"
                                    },
                                    "Schedule":{
                                       "properties":{
                                          "Duration":{
                                             
                                          },
                                          "Expiration":{
                                             "properties":{
                                                "Duration":{
                                                   
                                                },
                                                "EndDateTime":{
                                                   
                                                },
                                                "Type":{
                                                   "type":"string"
                                                }
                                             },
                                             "type":"object"
                                          },
                                          "Recurrence":{
                                             
                                          },
                                          "StartDateTime":{
                                             "type":"string"
                                          },
                                          "StopDateTime":{
                                             
                                          }
                                       },
                                       "type":"object"
                                    },
                                    "Target":{
                                       "properties":{
                                          "ConnectedOrganization":{
                                             
                                          },
                                          "ConnectedOrganizationId":{
                                             
                                          },
                                          "DisplayName":{
                                             "type":"string"
                                          },
                                          "Email":{
                                             "type":"string"
                                          },
                                          "Id":{
                                             "type":"string"
                                          },
                                          "ObjectId":{
                                             "type":"string"
                                          },
                                          "PrincipalName":{
                                             "type":"string"
                                          },
                                          "Tenant":{
                                             "properties":{
                                                "DisplayName":{
                                                   "type":"string"
                                                },
                                                "Id":{
                                                   "type":"string"
                                                },
                                                "InitialDomainName":{
                                                   "type":"string"
                                                }
                                             },
                                             "type":"object"
                                          },
                                          "Type":{
                                             "type":"string"
                                          }
                                       },
                                       "type":"object"
                                    },
                                    "TargetId":{
                                       "type":"string"
                                    }
                                 },
                                 "type":"object"
                              },
                              "CallbackConfiguration":{
                                 "properties":{
                                    "DurationBeforeTimeout":{
                                       "type":"string"
                                    }
                                 },
                                 "type":"object"
                              },
                              "CallbackUriPath":{
                                 "type":"string"
                              },
                              "CustomExtensionStageInstanceId":{
                                 "type":"string"
                              },
                              "RequestType":{
                                 "type":"integer"
                              },
                              "Requestor":{
                                 "properties":{
                                    "AltSecId":{
                                       
                                    },
                                    "ConnectedOrganization":{
                                       
                                    },
                                    "ConnectedOrganizationId":{
                                       
                                    },
                                    "CreatedDateTime":{
                                       "type":"string"
                                    },
                                    "DisplayName":{
                                       "type":"string"
                                    },
                                    "Email":{
                                       "type":"string"
                                    },
                                    "Id":{
                                       "type":"string"
                                    },
                                    "ObjectId":{
                                       "type":"string"
                                    },
                                    "OnPremisesSecurityIdentifier":{
                                       
                                    },
                                    "PrincipalName":{
                                       "type":"string"
                                    },
                                    "SubjectLifecycle":{
                                       "type":"string"
                                    },
                                    "SubjectType":{
                                       "type":"string"
                                    },
                                    "Tenant":{
                                       "properties":{
                                          "BannerLogoUrl":{
                                             
                                          },
                                          "BrandingLocale":{
                                             
                                          },
                                          "DisplayName":{
                                             
                                          },
                                          "Id":{
                                             "type":"string"
                                          },
                                          "InitialDomainName":{
                                             
                                          },
                                          "IsTestTenant":{
                                             "type":"boolean"
                                          },
                                          "PremiumSku":{
                                             "type":"string"
                                          },
                                          "PrivacyUrl":{
                                             
                                          }
                                       },
                                       "type":"object"
                                    },
                                    "Type":{
                                       "type":"string"
                                    }
                                 },
                                 "type":"object"
                              },
                              "Stage":{
                                 "type":"integer"
                              },
                              "State":{
                                 "type":"integer"
                              },
                              "Status":{
                                 "type":"string"
                              }
                           },
                           "type":"object"
                        }
                     },
                     "operationOptions":"IncludeAuthorizationHeadersInOutputs"
                  }
               },
               "actions":{
                  "Condition":{
                     "actions":{
                        "Condition_2":{
                           "actions":{
                              
                           },
                           "expression":{
                              "and":[
                                 {
                                    "equals":[
                                       "@triggerBody()?['Event']",
                                       "CustomExtensionConnectionTest"
                                    ]
                                 }
                              ]
                           },
                           "runAfter":{
                              
                           },
                           "type":"If"
                        }
                     },
                     "expression":{
                        "and":[
                           {
                              "equals":[
                                 "[variables('catalogIdExpression')]",
                                 "[trim(parameters('catalogId'))]"
                              ]
                           }
                        ]
                     },
                     "runAfter":{
                        
                     },
                     "type":"If"
                  }
               },
               "outputs":{
                  
               }
            },
            "parameters":{
               
            },
            "accessControl":{
               "triggers":{
                  "openAuthenticationPolicies":{
                     "policies":{
                        "AzureADEntitlementManagementPOPAuthPolicy":{
                           "type":"AADPOP",
                           "claims":[
                              {
                                 "name":"iss",
                                 "value":"[concat('https://sts.windows.net/', subscription().tenantId, '/')]"
                              },
                              {
                                 "name":"appid",
                                 "value":"810dcf14-1858-4bf2-8134-4c369fa3235b"
                              },
                              {
                                 "name":"m",
                                 "value":"POST"
                              },
                              {
                                 "name":"u",
                                 "value":"[trim(parameters('armResource'))]"
                              },
                              {
                                 "name":"nonce",
                                 "value":"[trim(parameters('nonce'))]"
                              },
                              {
                                 "name":"p",
                                 "value":"[variables('possession')]"
                              }
                           ]
                        }
                     }
                  }
               }
            }
         }
      }
   ]
}
